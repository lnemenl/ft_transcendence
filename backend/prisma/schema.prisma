// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite" // As required by the project spec
  url = env("DATABASE_URL") // We'll get the database location from our .env file
}

// This block defines our User "model", which will become a "users" table in the database.
model User {
  id                String      @id @default(cuid()) // A unique, auto-incrementing number for each user (Primary Key)
  email             String      @unique // The user's email address, which must be unique
  password          String      // Where we will store the securely hashed password
  username          String      @unique// The players username to be used throughout the website
  avatarUrl         String?

  games             Game[]      @relation("UserGames") // The games that the user has participated in
  gamesWon          Game[]      @relation("GameWinner") // The games that the user has won
  tournaments       Tournament[] @relation("UserTournaments") // The tournaments the user has participated in
  tournamentsWon    Tournament[] @relation("TournamentWinner") // The tournaments the user has won
  // Fields for Two-Factor Authentication (2FA)
  isTwoFactorEnabled Boolean @default(false)
  twoFactorSecret    String? //The '?' makes this field optional

  googleId           String?   @unique // Google's unique user ID, must be unique

  createdAt DateTime @default(now()) // Automatically set the creation timestamp
  updatedAt DateTime @updatedAt    // Automatically update the timestamp on any change

    // Relation: a user can have multiple refresh tokens (multiple devices)
  refreshTokens       RefreshToken[]
}

model Game {
  id            String      @id @default(cuid()) // A unique game id
  winnerId      String?      // The id of the winner player
  winner        User?        @relation("GameWinner", fields: [winnerId], references: [id]) // Link to the winner player
  players       User[]       @relation("UserGames") // Players that participated in the game
  tournamentId  String?     // OPTIONAL: The tournament id that the game is in
  tournament    Tournament? @relation(fields: [tournamentId], references: [id]) // OPTIONAL: The tournament that the game is in
  createdAt     DateTime    @default(now()) // The date of the game
}

model Tournament {
  id            String    @id @default(cuid()) // A unique tournament id
  winnerId      String?  // The id of the tournament winner
  winner        User?     @relation("TournamentWinner", fields: [winnerId], references: [id]) // The winner of the tournament
  games         Game[] // The games that the tournament has
  participants  User[]    @relation("UserTournaments") // The players that participated in the tournament
  startDate     DateTime  @default(now()) // The date that the tournament started
  endDate       DateTime? // The date that the tournament ended, can be NULL if the tournament has not ended yet
}

// This block defines the users JWT refresh tokens so that the user can refresh their API access token when expired
model RefreshToken {
  id                  String   @id @default(cuid())
  tokenHash           String   @unique // SHA-256 hash of the opaque refresh token (not the raw token)
  user                User     @relation(fields: [userId], references: [id])
  userId              String

  createdAt           DateTime @default(now())
  expiresAt           DateTime
  revoked             Boolean  @default(false)
}